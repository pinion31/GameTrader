{"version":3,"sources":["../../server/routes/requests.js"],"names":["express","require","router","Router","User","post","req","res","userRequests","Array","from","body","findOneAndUpdate","username","session","user","$push","requests","new","then","incomingRequest","Object","assign","newRequest","status","requestedGame","offeredGame","path","owner","json","findOne","lean","filter","request","id","requestedGameId","offeredGameId","get","map","key","_id","module","exports"],"mappings":"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","file":"requests.js","sourcesContent":["'use strict';\r\n\r\nconst express = require('express');\r\nconst router = express.Router();\r\nconst User = require('../models/user');\r\n\r\n/** Trader = user that created offer\r\n*   Tradee = user that receives offer and decides to accept trade or decline\r\n**/\r\n\r\n/**\r\n * Adds Request to current user\r\n * Input {Array of one obj} - obj format {\r\n    offeredGame: Object,\r\n    requestedGame: Object\r\n }\r\n * Output: {Array} - sends back current user request with newly added request\r\n */\r\n\r\nrouter.post('/addRequest', (req, res) => {\r\n  const userRequests = Array.from(req.body);\r\n  // Request added to Tradee here\r\n  User.findOneAndUpdate({username: req.session.user}, {$push: {requests: userRequests[0]}}, {new:true})\r\n    .then((user) => {\r\n      const incomingRequest = Object.assign({}, req.body[0]);\r\n      // create new request for Tradee and append to Tradee requests\r\n      const newRequest = {\r\n        status: 'Pending',\r\n        requestedGame: incomingRequest.offeredGame,\r\n        offeredGame: incomingRequest.requestedGame,\r\n        path: 'incoming',\r\n      };\r\n\r\n      // Request added to Trader here\r\n      User.findOneAndUpdate(\r\n        {username: incomingRequest.requestedGame.owner.username},\r\n        {$push: {requests: newRequest}})\r\n        .then(() => {\r\n          res.json(user.requests);\r\n        });\r\n    });\r\n});\r\n\r\n/**\r\n * Removes request from current user\r\n * Output {Array}: sends back array of user requests minus removed request\r\n */\r\nrouter.post('/removeRequest', (req, res) => {\r\n  User.findOne({username: req.session.user}).lean()\r\n    .then((user) => {\r\n      const userRequests = user.requests.filter((request) => {\r\n        if (request.requestedGame.id != req.body.requestedGameId ||\r\n            request.offeredGame.id != req.body.offeredGameId) {\r\n          return request;\r\n        }\r\n      });\r\n\r\n      User.findOneAndUpdate({username: req.session.user}, {requests: userRequests})\r\n        .then(() => {\r\n          res.json(userRequests);\r\n        });\r\n    });\r\n});\r\n\r\n/**\r\n * Retrieves current user requests\r\n * @param {String} req.session.user\r\n * Output: {Array} userRequests - sends back array of request objs\r\n * if no session user, sends back {session: 'none'} for error handling\r\n */\r\nrouter.get('/getUserRequests', (req, res) => {\r\n  if (req.session.user) {\r\n    User.findOne({username: req.session.user}).lean()\r\n      .then((user) => {\r\n        if (user.requests) {\r\n          let userRequests = Array.from(user.requests);\r\n          userRequests.map((request, key) => {\r\n            request.offeredGame.owner =\r\n              {username: req.session.user, id: user._id};\r\n\r\n            request.requestedGame.owner = //converts requestGame.owner from String to Obj ({username: String, id: String})\r\n            { username: user.requests[key].requestedGame.owner.username,\r\n              id: user.requests[key].requestedGame.owner.id\r\n            };\r\n          });\r\n          res.json(userRequests);\r\n        } else {\r\n          res.json([]);\r\n        }\r\n      });\r\n  } else {\r\n    res.json({session: 'none'});\r\n  }\r\n});\r\n\r\nmodule.exports = router;\r\n"]}