{"version":3,"sources":["../../server/routes/requests.js"],"names":["express","require","router","Router","User","post","req","res","userRequests","Array","from","body","findOneAndUpdate","username","session","user","$push","requests","new","then","incomingRequest","Object","assign","newRequest","status","requestedGame","offeredGame","path","owner","json","findOne","lean","filter","request","id","requestedGameId","offeredGameId","get","map","key","_id","console","log","module","exports"],"mappings":"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","file":"requests.js","sourcesContent":["const express = require('express');\r\nconst router = express.Router();\r\nconst User = require('../models/user');\r\n\r\nrouter.post('/addRequest', (req, res) => {\r\n  const userRequests = Array.from(req.body);\r\n  User.findOneAndUpdate({username: req.session.user}, {$push: {requests: userRequests[0]}}, {new:true})\r\n    .then((user) => {\r\n      const incomingRequest = Object.assign({}, req.body[0]);\r\n      // create request for recipient of trade offer and append to their requests\r\n      const newRequest = {\r\n        status: 'Pending',\r\n        requestedGame: incomingRequest.offeredGame,\r\n        offeredGame: incomingRequest.requestedGame,\r\n        path: 'incoming',\r\n      };\r\n\r\n      User.findOneAndUpdate(\r\n        {username: incomingRequest.requestedGame.owner.username},\r\n        {$push: {requests: newRequest}})\r\n        .then(() => {\r\n          res.json(user.requests);\r\n        });\r\n    });\r\n});\r\n\r\nrouter.post('/removeRequest', (req, res) => {\r\n  User.findOne({username: req.session.user}).lean()\r\n    .then((user) => {\r\n      const userRequests = user.requests.filter((request) => {\r\n        if (request.requestedGame.id != req.body.requestedGameId &&\r\n            request.offeredGame.id != req.body.offeredGameId) {\r\n          return request;\r\n        }\r\n      });\r\n\r\n      User.findOneAndUpdate({username: req.session.user}, {requests: userRequests})\r\n        .then(() => {\r\n          res.json(userRequests);\r\n        });\r\n    });\r\n});\r\n\r\nrouter.get('/getUserRequests', (req, res) => {\r\n  if (req.session.user) {\r\n    User.findOne({username: req.session.user}).lean()\r\n      .then((user) => {\r\n        if (user.requests) {\r\n          let userRequests = Array.from(user.requests);\r\n          userRequests.map((request, key) => {\r\n\r\n            //request.offeredGame.owner_id = request.offeredGame.owner._id;\r\n            request.offeredGame.owner =\r\n              {username: req.session.user, id: user._id};\r\n\r\n            console.log('request.requestedGame.owner', request.requestedGame.owner);\r\n            //request.requestedGame.owner_id = request.requestedGame.owner._id;\r\n           //request.requestedGame.owner =\r\n           // user.requests[key].requestedGame.owner.username;\r\n\r\n            request.requestedGame.owner =\r\n            { username: user.requests[key].requestedGame.owner.username,\r\n              id: user.requests[key].requestedGame.owner._id\r\n            };\r\n          });\r\n\r\n          res.json(userRequests);\r\n        } else {\r\n          res.json([]);\r\n        }\r\n      });\r\n  } else {\r\n    res.json({session: 'none'});\r\n  }\r\n});\r\n\r\nmodule.exports = router;\r\n"]}