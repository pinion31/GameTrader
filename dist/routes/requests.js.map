{"version":3,"sources":["../../server/routes/requests.js"],"names":["express","require","router","Router","User","post","req","res","userRequests","Array","from","body","findOneAndUpdate","username","session","user","$push","requests","then","incomingRequest","Object","assign","newRequest","status","requestedGame","offeredGame","path","owner","json","findOne","lean","filter","request","id","requestedGameId","offeredGameId","get","module","exports"],"mappings":";;AAAA,IAAMA,UAAUC,QAAQ,SAAR,CAAhB;AACA,IAAMC,SAASF,QAAQG,MAAR,EAAf;AACA,IAAMC,OAAOH,QAAQ,gBAAR,CAAb;;AAEAC,OAAOG,IAAP,CAAY,aAAZ,EAA2B,UAACC,GAAD,EAAMC,GAAN,EAAc;AACvC,MAAMC,eAAeC,MAAMC,IAAN,CAAWJ,IAAIK,IAAf,CAArB;;AAEAP,OAAKQ,gBAAL,CAAsB,EAACC,UAAUP,IAAIQ,OAAJ,CAAYC,IAAvB,EAAtB,EAAoD,EAACC,OAAO,EAACC,UAAUT,aAAa,CAAb,CAAX,EAAR,EAApD,EACGU,IADH,CACQ,YAAM;AACV,QAAMC,kBAAkBC,OAAOC,MAAP,CAAc,EAAd,EAAkBf,IAAIK,IAAJ,CAAS,CAAT,CAAlB,CAAxB;AACA;AACA,QAAMW,aAAa;AACjBC,cAAQ,SADS;AAEjBC,qBAAeL,gBAAgBM,WAFd;AAGjBA,mBAAaN,gBAAgBK,aAHZ;AAIjBE,YAAM;AAJW,KAAnB;;AAOAtB,SAAKQ,gBAAL,CACE,EAACC,UAAUM,gBAAgBK,aAAhB,CAA8BG,KAAzC,EADF,EAEE,EAACX,OAAO,EAACC,UAAUK,UAAX,EAAR,EAFF,EAGGJ,IAHH,CAGQ,YAAM;AACVX,UAAIqB,IAAJ,CAAStB,IAAIK,IAAb;AACD,KALH;AAMD,GAjBH;AAkBD,CArBD;;AAuBAT,OAAOG,IAAP,CAAY,gBAAZ,EAA8B,UAACC,GAAD,EAAMC,GAAN,EAAc;AAC1CH,OAAKyB,OAAL,CAAa,EAAChB,UAAUP,IAAIQ,OAAJ,CAAYC,IAAvB,EAAb,EAA2Ce,IAA3C,GACGZ,IADH,CACQ,UAACH,IAAD,EAAU;AACd,QAAMP,eAAeO,KAAKE,QAAL,CAAcc,MAAd,CAAqB,UAACC,OAAD,EAAa;AACrD,UAAIA,QAAQR,aAAR,CAAsBS,EAAtB,IAA4B3B,IAAIK,IAAJ,CAASuB,eAArC,IACAF,QAAQP,WAAR,CAAoBQ,EAApB,IAA0B3B,IAAIK,IAAJ,CAASwB,aADvC,EACsD;AACpD,eAAOH,OAAP;AACD;AACF,KALoB,CAArB;;AAOA5B,SAAKQ,gBAAL,CAAsB,EAACC,UAAUP,IAAIQ,OAAJ,CAAYC,IAAvB,EAAtB,EAAoD,EAACE,UAAUT,YAAX,EAApD,EACGU,IADH,CACQ,YAAM;AACVX,UAAIqB,IAAJ,CAASpB,YAAT;AACD,KAHH;AAID,GAbH;AAcD,CAfD;;AAiBAN,OAAOkC,GAAP,CAAW,kBAAX,EAA+B,UAAC9B,GAAD,EAAMC,GAAN,EAAc;AAC3C,MAAID,IAAIQ,OAAJ,CAAYC,IAAhB,EAAsB;AACpBX,SAAKyB,OAAL,CAAa,EAAChB,UAAUP,IAAIQ,OAAJ,CAAYC,IAAvB,EAAb,EAA2Ce,IAA3C,GACGZ,IADH,CACQ,UAACH,IAAD,EAAU;AACd,UAAIA,KAAKE,QAAT,EAAmB;AACjBV,YAAIqB,IAAJ,CAASb,KAAKE,QAAd;AACD,OAFD,MAEO;AACLV,YAAIqB,IAAJ,CAAS,EAAT;AACD;AACF,KAPH;AAQD,GATD,MASO;AACLrB,QAAIqB,IAAJ,CAAS,EAACd,SAAS,MAAV,EAAT;AACD;AACF,CAbD;;AAeAuB,OAAOC,OAAP,GAAiBpC,MAAjB","file":"requests.js","sourcesContent":["const express = require('express');\r\nconst router = express.Router();\r\nconst User = require('../models/user');\r\n\r\nrouter.post('/addRequest', (req, res) => {\r\n  const userRequests = Array.from(req.body);\r\n\r\n  User.findOneAndUpdate({username: req.session.user}, {$push: {requests: userRequests[0]}})\r\n    .then(() => {\r\n      const incomingRequest = Object.assign({}, req.body[0]);\r\n      // create request for recipient of trade offer and append to their requests\r\n      const newRequest = {\r\n        status: 'Pending',\r\n        requestedGame: incomingRequest.offeredGame,\r\n        offeredGame: incomingRequest.requestedGame,\r\n        path: 'incoming',\r\n      };\r\n\r\n      User.findOneAndUpdate(\r\n        {username: incomingRequest.requestedGame.owner},\r\n        {$push: {requests: newRequest}})\r\n        .then(() => {\r\n          res.json(req.body);\r\n        });\r\n    });\r\n});\r\n\r\nrouter.post('/removeRequest', (req, res) => {\r\n  User.findOne({username: req.session.user}).lean()\r\n    .then((user) => {\r\n      const userRequests = user.requests.filter((request) => {\r\n        if (request.requestedGame.id != req.body.requestedGameId &&\r\n            request.offeredGame.id != req.body.offeredGameId) {\r\n          return request;\r\n        }\r\n      });\r\n\r\n      User.findOneAndUpdate({username: req.session.user}, {requests: userRequests})\r\n        .then(() => {\r\n          res.json(userRequests);\r\n        });\r\n    });\r\n});\r\n\r\nrouter.get('/getUserRequests', (req, res) => {\r\n  if (req.session.user) {\r\n    User.findOne({username: req.session.user}).lean()\r\n      .then((user) => {\r\n        if (user.requests) {\r\n          res.json(user.requests);\r\n        } else {\r\n          res.json([]);\r\n        }\r\n      });\r\n  } else {\r\n    res.json({session: 'none'});\r\n  }\r\n});\r\n\r\nmodule.exports = router;\r\n"]}